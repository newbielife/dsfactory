<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="webkit" name="renderer"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta content="no-cache" http-equiv="Pragma"/>
    <meta http-equiv="Expires" content="0"/>
    <meta content="width=device-width, initial-scale=1, user-scalable=1" name="viewport"/>
    <title>大山食品厂</title>
    <link rel="shortcut icon" href="images/dslogo.ico" type="image/x-icon"/>
    <script src="js/global.min.js?ctx=/js/a"></script>
    <script src="js/jquery/jquery-1.12.4.min.js"></script>
    <!--[if lt IE 9]><script src="js/common/h5fix.min.js"></script><![endif]-->
    <link rel="stylesheet" href="css/fonts/font-icons.min.css">
    <link rel="stylesheet" href="js/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="js/select2/4.0/select2.css">
    <link rel="stylesheet" href="js/icheck/1.0/minimal/grey.css">
    <link rel="stylesheet" href="js/adminlte/css/AdminLTE.min.css">
    <link rel="stylesheet" href="js/modules/sys/sysRegister.css">
    <link rel="stylesheet" href="css/DSerp.css">
    <link rel="stylesheet" href="js/adminlte/css/skins/skin-blue-light2.css">
    <script type="text/javascript" src="js/gVerify.js"></script>
</head>
<body class="hold-transition login-page">
<div class="wrapper">
    <!--[if lte IE 9]><a style="position:absolute;top:0;left:0;z-index:100000;display:block;width:100%;font-size:14px;
    color:#F00;text-decoration:none;background-color:#faffb3;text-align:center;" href="js/upbw/index.html" target="_blank">
    您的浏览器版本过低或在兼容模式下，导致打开速度过慢，提升速度您可以切换到极速模式或升级为最新版，点击此处查看详情。</a>
    <![endif]-->
    <!--[if lte IE 8]><script>window.location.href = '/js/static/upbw/index.html';</script><![endif]-->
    <!-- <link rel="stylesheet" href="js/static/icheck/1.0/square/blue.css"> -->
    <link rel="stylesheet" href="js/jquery-toastr/2.0/toastr.min.css">
    <link rel="stylesheet" href="js/modules/sys/sysLogin.css">
    <div class="login-box">
        <div class="login-logo">
            <a href="/">
                <b>大山食品厂</b>
                <small>V1.0</small>
            </a>
        </div>
        <div class="login-box-body">
            <div class="form-group has-feedback">
                <span class="glyphicon glyphicon-user form-control-feedback" title="登录账号"></span>
                <input type="text" id="username" name="username" class="form-control required"
                       data-msg-required="请填写登录账号." placeholder="登录账号"/>
            </div>
            <div class="form-group has-feedback">
                <span class="glyphicon glyphicon-lock form-control-feedback"
                      title="登录密码，鼠标按下显示密码"
                      onmousedown="$('#password').attr('type','text')"
                      onmouseup="$('#password').attr('type','password')">
                </span>
                <input type="password" id="password" name="password" class="form-control required"
                       data-msg-required="请填写登录密码." placeholder="登录密码" autocomplete="off"/>
            </div>
            <!--<div class="register-box">-->
                <!--<div class="form-group has-feedback" id="isValidCodeLogin">-->
                    <!--<div class="input-group">-->
                        <!--<span class="input-group-addon">验证码：</span>-->
                        <!--<input type="text" id="validCode" name="validCode" class="form-control" required="true"-->
                               <!--data-msg-required="请填写验证码"  data-msg-remote="验证码不正确."/>-->
                        <!--<span class="input-group-addon p0">-->
                        <!--<div id="imgCaptcha"  title="点击刷新验证码"></div>-->
                    <!--</span>-->
                    <!--</div>-->
                <!--</div>-->
            <!--</div>-->
            <div class="form-group has-feedback" id="isValidCodeLogin">
                <div class="input-group">
                    <span class="input-group-addon">验证码：</span>
                    <input type="text" id="validCode" name="validCode" class="form-control" required="true"
                           data-msg-required="请填写验证码"  data-msg-remote="验证码不正确."/>
                    <span class="input-group-addon p0">
                        <div id="imgCaptcha" title="点击刷新验证码"></div>
                    </span>
                </div>
            </div>
            <div class="form-group">
                <div class="mt5 icheck">
                    <label title="公共场所慎用,下次不需要再填写帐号"><input type="checkbox"
                                                            id="rememberUserCode" class="form-control" data-style="minimal-grey">记住账号</label> &nbsp;
                    <label title="公共场所慎用,下次不需要再填写帐号和密码"><input type="checkbox"
                                                               id="rememberMe" class="form-control" data-style="minimal-grey"> 记住密码</label>
                </div>
            </div>
            <div class="form-group">
                <input type="hidden" name="__url" value="">
                <button type="submit" class="btn btn-primary btn-block btn-flat"
                        id="btnSubmit" data-loading="登录验证成功，正在进入..."
                        data-login-valid="正在验证登录，请稍候...">立即登录
                </button>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <a href="register.html" class="pull-left">[ 还没账号？立即注册 ]</a>
                    <div class="dropdown pull-right">使用
                        <a href="#" class="dropdown-toggle">
                            <i class="fa icon-globe"></i> MIT许可
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="login-copyright">
            ©2020 By&nbsp;
            <a style="color:#00458a;" href="#" target="_blank">郭煜畅</a>
            <a style="color:#00458a;" href="#" target="_blank">陆勇作</a>
            <a style="color:#00458a;" href="#" target="_blank">张天萌</a>
            <a style="color:#00458a;" href="#" target="_blank"> ；</a>
            <br>&emsp;&emsp;&emsp;&emsp;&emsp;
            <a style="color:#00458a;" href="#" target="_blank">刘自轩</a>
            <a style="color:#00458a;" href="#" target="_blank">张哲源</a>
            <a style="color:#00458a;" href="#" target="_blank">刘达维</a>
        </div>
    </div>
</div>

<a id="scroll-up" href="#" class="btn btn-sm"><i class="fa fa-angle-double-up"></i></a>
<script src="js/bootstrap/js/bootstrap.min.js"></script>
<script src="js/select2/4.0/select2.js"></script>
<script src="js/select2/4.0/i18n/zh_CN.js"></script>
<script src="js/layer/3.1/layer.js"></script>
<script src="js/jquery-validation/1.16/jquery.validate.js"></script>
<script src="js/jquery-validation/1.16/localization/messages_zh_CN.js"></script>
<script src="js/jquery-validation/1.16/jquery.validate.extend.js"></script>
<script src="js/common/DSerp.js"></script>
<script src="js/common/i18n/DSerp_zh_CN.js"></script>
<script src="js/md5/md5.js"></script>
<script src="js/modules/sys/sysLogin.js"></script>



<script>

    //初始化键盘enter事件
    $(document).keydown(function (event) {
        //兼容 IE和firefox 事件
        var e = window.event || event;
        var k = e.keyCode || e.which || e.charCode;
        //兼容 IE,firefox 兼容
        var obj = e.srcElement ? e.srcElement : e.target;
        //绑定键盘事件为 username 和password的输入框才可以触发键盘事件 13键盘事件
        if (k == "13" && (obj.id == "username" || obj.id == "password"||obj.id == "validCode" ))
            loginFun();
    });


    $("#username, #password").on("focus blur", function () {
        var a = this;
        setTimeout(function () {
            var b = $(a).css("borderColor");
            if (b != "") {
                $(a).prev().css("color", b)
            }
        }, 100)
    }).blur();
    var verifyCode = new GVerify("imgCaptcha");
    //注册按钮绑定处理事件

    $("#btnSubmit").off("click").on("click", function () {
        loginFun();
    });

    function loginFun() {
        if($("#validCode").val()) {
            var res = verifyCode.validate($("#validCode").val());
            if(res){
                $.ajax({
                    type: "post",
                    url: "/user/login",
                    dataType: "json",
                    data: ({
                        loginame: $("#username").val(),
                        password:  hex_md5($("#password").val())
                    }),
                    success: function (res) {
                        if(res) {
                            var loginInfoTip = res.data.msgTip;
                            //用户名不存在，清空输入框并定位到用户名输入框
                            if (loginInfoTip.indexOf("staff is not exist") != -1) {
                                $("#username").val("").focus();
                                $("#password").val("");
                                alert("用户名不存在");
                                return;
                            }
                            else if (loginInfoTip.indexOf("staff password error") != -1) {
                                alert("用户密码错误");
                                return;
                            }
                            else if (loginInfoTip.indexOf("access service error") != -1) {
                                alert("后台访问错误");
                                return;
                            }
                            //跳转到用户管理界面
                            else if (loginInfoTip.indexOf("staff can login") != -1 || loginInfoTip == "staff already login") {
                                $.ajax({
                                    type: "get",
                                    url: "/user/getUserSession",
                                    dataType: "json",
                                    success: function (res) {
                                        if(res && res.code === 200) {
                                            if(res.data.user) {
                                                var user = res.data.user;
                                                sessionStorage.setItem("userId", user.id);
                                                top.location.href = "/index.html";
                                            }
                                        }
                                    },
                                    //此处添加错误处理
                                    error: function () {
                                        alert("后台访问错误，请联系管理员!!！");
                                    }
                                });
                            }
                        }
                    },
                    //此处添加错误处理
                    error: function () {
                        alert("后台访问错误，请联系管理员！");
                    }
                });
            } else{
                alert("验证码错误!");
                $("#validCode").val("");
            }
        } else {
            alert("验证码为空!");
            $("#validCode").val("");
        }
    }
</script>


